<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rebuild</title>
</head>
<body>
    <canvas id="myCanvas" width="400" height="300" style="border: 1px solid #333 ">

    </canvas>
</body>
<script>
    // 帮助函数：载入图片
    function loadImageByPath(path) {
        var img = new Image(path);
        img.src = path;
        return img;
    }
    // 表示底盘
    function Piddle() {
        this.x = 100;
        this.y = 200;
        this.step = 10;
        this.imge = loadImageByPath('imgs/block.png');
    }
    Piddle.prototype = (function () {

        return{
            moveLeft:function () {
                this.x  -= this.step;
                this.x  = Math.max(0,this.x)
            },
            moveRight:function () {
                this.x  += this.step;
                this.x  = Math.min(400-80 ,this.x)
            },
            collide:function (ball) {
                var  self = this;
                if(ball.y + 40 > self.y ){
                    if(ball.x > self.x && ball.x < self.x + 70){
                        return true;
                    }
                }
            }

        }
    })()
    //表球
    function Ball() {
        this.x = 200;
        this.y = 200;
        this.stepX = 10;
        this.stepY = 9;
        this.imge = loadImageByPath('imgs/ball.png');
        this.fired = false;
    }
    Ball.prototype = {
        fire:function () {
            this.fired = true;
        },
        move:function () {
          //限制 X 轴 范围
          if( this.x < 0 || this.x + 70 > 400 ){
              this.stepX *= -1;
          }
          // Y
          if( this.y < 0 || this.y + 50 > 300 ){
                this.stepY *= -1;
            }

            this.x += this.stepX;

            this.y += this.stepY;
        }
    }
    // 表砖块
    //表示画布
    function Game() {
        //事件注册
        this.activity = {};
        this.keydowns = {};
        this.ctx = document.getElementById('myCanvas').getContext('2d');
        this._bindEvent();
        this.draw = null;
        this.update = null;
    }
    Game.prototype = {
        drawImage:function (paddle) {
            this.ctx.drawImage(paddle.imge,paddle.x,paddle.y);
        },
        clean:function () {
            this.ctx.clearRect(0,0,400,300);
        },
        registerAction:function (event, callback) {
            this.activity[event] = callback;
        },
        _bindEvent:function () {
            var self = this;
            window.addEventListener('keydown',function (e) {
                self.keydowns[e.key] = true;
            });
            window.addEventListener('keyup',function (e) {
                self.keydowns[e.key] = false;
            });
            return self;
        },
        triggerEvent:function () {
            var self = this;
            for(var i in self.activity ){
                if(self.keydowns[i]){
                    self.activity[i]();
                }
            }
        },
        bindInterval:function () {
            var self = this;
            setInterval(function () {
                self.triggerEvent();
                self.update();
                self.clean();
                self.draw();
            }.bind(self),1000/30)
        }
    }
    // main
    var main = function () {
        var piddle = new Piddle();
        var game = new Game();
        var ball = new Ball();
        game.draw = function () {
            game.drawImage(piddle);
            game.drawImage(ball);
        };
        game.update = function () {
            if(ball.fired){
                ball.move();
            }
            if(piddle.collide(ball)){
                ball.stepX *= -1;
                ball.stepY *= -1;
            }
        };
        game.registerAction('a', function () {
            piddle.moveLeft();
        });
        game.registerAction('d', function () {
            piddle.moveRight();
        });
        game.registerAction('f', function () {
            ball.fire();
        });
        game.bindInterval();

    }
    main();
</script>
</html>